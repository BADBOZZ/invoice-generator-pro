# Security Posture – Invoice Generator Pro

_Last updated: 2025-11-25_

## 1. Overview

The backend now exposes a minimal-yet-hardened Express API focused on safe invoice creation. All endpoints are protected by API key authentication, rate limited, validated, and sanitized before reaching business logic. The service is designed for containerized or bare-metal deployments and requires environment-based configuration (`.env` or secret manager).

## 2. Implemented Controls

| Control | Implementation | Notes |
| --- | --- | --- |
| Security headers | `helmet` CSP, Referrer-Policy, Permissions-Policy (`src/middleware/security.js`) | Blocks mixed content, framing, and data exfil vectors. |
| Transport security | Enforce TLS at reverse proxy | App assumes HTTPS termination upstream; never expose over plain HTTP. |
| Authentication | Mandatory `x-api-key` per request (`src/middleware/auth.js`) | Rotate frequently; store in secret manager. |
| Authorization | Route-level check prior to controllers | Extend with user/role mapping (future). |
| Rate limiting | `express-rate-limit` global limiter configurable via env | Default: 60 req/min per IP. |
| Input validation | `celebrate`/`Joi` schemas (`src/validators/invoiceValidators.js`) | Guards against injection, overflow, invalid currencies. |
| Input sanitization | Recursive HTML sanitizer (`src/middleware/inputSanitizer.js`) | Neutralizes XSS payloads in body/params/query. |
| HPP mitigation | `hpp` | Prevents query parameter pollution. |
| Logging | Structured logger with header redaction (`src/utils/logger.js`) | Avoids leaking API keys in logs. |
| Error handling | Centralized handler + Celebrate error serializer | Prevents stack traces from reaching clients. |
| Testing | `node:test` + `supertest` coverage of auth, health, validation | `npm test` prior to deployment. |

## 3. Threat Model

### Assets
- Invoice payloads (PII/confidential pricing)
- API key and infrastructure credentials
- Service availability/reputation

### Actors
- **Legitimate**: internal finance tooling, automation services
- **Adversarial**: external attackers, abusive clients, compromised insiders

### Attack Vectors & Mitigations
- **Brute-force / credential stuffing** – Mitigated via rate limiting and logging; add WAF/IDS for production.
- **Injection (SQL/NoSQL/XSS)** – Mitigated through validation, sanitization, and consistent encoding.
- **Replay / stolen API key** – Rotate keys, prefer time-bound signed tokens, monitor unusual IPs.
- **DoS / resource exhaustion** – Global limiter + request body size caps; add autoscaling and anomaly detection.
- **Data exfiltration** – Strict CORS allow list, CSP, removed referrers, no verbose errors.

### Assumptions
- Service sits behind TLS-terminating load balancer.
- Secrets delivered at runtime (env vars / secret store).
- Downstream persistence layer will enforce additional row-level security.

## 4. Secure Operations Guide

1. **Provision secrets** – Copy `.env.example`, set `INVOICE_API_KEY`, and store the actual value in a secret manager.
2. **Rotate keys** – Issue unique API keys per client and rotate at least every 90 days. Revoke compromised keys immediately.
3. **Monitor logs** – Forward stdout/stderr to SIEM. Alert on repeated 401/429 spikes and unusual geographies.
4. **Patch cadence** – Run `npm audit` weekly; update dependencies promptly.
5. **Deployment hardening** – Run the node process as non-root, disable shell access, and pin container base images.
6. **Backups & data at rest** – Once a DB is attached, enable encryption at rest and scheduled backups.

## 5. Residual Risks & Backlog

- In-memory invoice storage is non-persistent; integrate a least-privilege database with encrypted connections.
- Replace API key auth with OAuth 2.0 or signed JWTs for granular user scoping.
- Add anomaly detection, audit trails, and SIEM dashboards.
- Introduce automated dependency and container scanning in CI.
- Expand automated tests to cover edge cases (rate-limit exhaustion, malicious payload fuzzing).

## 6. Incident Response Checklist

1. Detect abnormal traffic (401/429 spikes).
2. Rotate exposed API keys and invalidate active tokens.
3. Capture relevant logs (with redactions) for forensic review.
4. Patch vulnerability, re-run `npm test`, redeploy.
5. Document incident learnings inside this file and `project_state.md`.
